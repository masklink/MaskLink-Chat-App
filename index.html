<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaskLink</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#000814;--text-color:#ffffff;--accent-color:#00ff9f;--secondary-accent:#3a8bfd;--error-color:#ff3b3b;--dark-blue-black:#000814;}body.light-theme{--bg:#f0f2f5;--text-color:#1c1e21;--accent-color:#008a5e;--secondary-accent:#1877f2;--dark-blue-black:#ffffff;}body{background-color:var(--bg);color:var(--text-color);font-family:'Share Tech Mono',monospace;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;transition:background-color .3s,color .3s;overflow-x:hidden;}*{box-sizing:border-box;}
        #bg-video{position:fixed;right:0;bottom:0;min-width:100%;min-height:100%;width:auto;height:auto;z-index:-100;background-size:cover;opacity:.3;}
        .container{width:100%;max-width:400px;padding:20px;display:flex;flex-direction:column;align-items:center;z-index:2;}.app-title{font-size:40px;color:var(--accent-color);text-shadow:0 0 10px var(--accent-color),0 0 20px var(--accent-color);text-align:center;margin-bottom:30px;}.app-title a{color:inherit;text-decoration:none;}.form-container{display:flex;flex-direction:column;width:100%;align-items:center;}input[type=email],input[type=password],input[type=text]{border-radius:25px;border:2px solid var(--accent-color);background:transparent;color:var(--text-color);padding:12px 20px;margin-bottom:15px;width:100%;max-width:350px;font-family:'Share Tech Mono',monospace;}input::placeholder{color:var(--text-color);opacity:.7;}button{border-radius:50px;background:var(--accent-color);color:var(--dark-blue-black);font-weight:700;border:none;padding:12px 0;cursor:pointer;width:100%;max-width:350px;transition:box-shadow .3s ease,background-color .3s;font-family:'Share Tech Mono',monospace;font-size:16px;margin-top:10px;}button.secondary{background:var(--secondary-accent);color:var(--white);}button.danger{background-color:#c92a2a;color:#fff;}button:hover{box-shadow:0 0 15px var(--accent-color);}.form-switch{font-size:13px;color:var(--text-color);text-align:center;margin-top:20px;}.form-switch span{color:var(--accent-color);text-decoration:underline;cursor:pointer;}.error-message{color:var(--error-color);text-align:center;margin-bottom:15px;font-size:14px;max-width:350px;}.hidden{display:none!important;}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000;}.modal-content{background:var(--bg);padding:30px;border-radius:10px;border:2px solid var(--accent-color);width:90%;max-width:400px;box-shadow:0 0 20px var(--secondary-accent);text-align:center;}.modal-content h2{color:var(--accent-color);margin-top:0;margin-bottom:20px;}.profile-id-display{background:rgba(255,255,255,.1);padding:10px;border-radius:10px;margin-top:15px;font-size:14px;color:var(--accent-color);border:1px dashed var(--accent-color);word-break:break-all;}#app-container{width:100%;height:100vh;z-index:1;}.main-app{width:100%;height:100%;display:flex;flex-direction:column;}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#000c1f;border-bottom:1px solid var(--accent-color);position:fixed;top:0;width:100%;z-index:100}body.light-theme .top-bar{background:#e9ebee;border-bottom:1px solid #ccc;}.top-bar .app-title-small{font-size:24px;color:var(--accent-color);text-shadow:0 0 5px var(--accent-color);}.top-bar .app-title-small a{color:inherit;text-decoration:none;}.main-content{flex-grow:1;padding:20px;overflow-y:auto;margin-top:60px;margin-bottom:60px;width:100%;}.page{display:none;}.page.active{display:block;}.bottom-bar{display:flex;justify-content:space-around;padding:10px 0;background:#000c1f;border-top:1px solid var(--accent-color);position:fixed;bottom:0;left:0;width:100%;z-index:100}.nav-button{position:relative;background:none;border:none;color:var(--text-color);font-family:'Share Tech Mono',monospace;font-size:16px;cursor:pointer;padding:5px 10px;}.nav-button:hover{color:var(--accent-color);}.notification-badge{position:absolute;top:-5px;right:0;background-color:var(--error-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:700;}
        .list-item{background-color:rgba(255,255,255,0.05);border:1px solid var(--accent-color);border-radius:10px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;text-align:left;}
        .list-item-main-info{flex-grow:1;display:flex;align-items:center;cursor:pointer;}
        .list-item-info{display:flex;flex-direction:column;flex-grow:1;position:relative;}
        .list-item-name{font-size:18px;}
        .list-item-emoji{font-size:24px;margin-right:15px;position:relative;}
        .list-item-actions{display:flex;flex-direction:row;gap:5px;}
        .list-item-actions button{width:auto;padding:4px 8px;font-size:11px;margin-top:0;min-width:auto;}
        .unread-dot{position:absolute;right:0;top:50%;transform:translateY(-50%);height:12px;width:12px;background-color:var(--secondary-accent);border-radius:50%;box-shadow:0 0 10px var(--secondary-accent);}
        .status-indicator { position: absolute; bottom: 0; right: -2px; height: 11px; width: 11px; border-radius: 50%; border: 2px solid var(--bg); }
        .status-indicator.online { background-color: var(--accent-color); }
        .status-indicator.offline { background-color: #6c757d; }
        #chat-view{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--bg);z-index:1010;display:flex;flex-direction:column;}.chat-header{display:flex;align-items:center;padding:10px;background-color:#000c1f;border-bottom:1px solid var(--accent-color);}.chat-header-info{flex-grow:1;display:flex;align-items:center;}.chat-header .back-button{background:none;border:none;color:var(--accent-color);font-size:24px;margin-right:15px;cursor:pointer;max-width:min-content;}.chat-header-info span:first-child{font-size:24px;margin-right:10px;}.chat-header-info span:last-child{font-size:18px;font-weight:700;}.chat-header .block-button{font-size:9px;padding:3px 6px;margin-left:auto;margin-top:0;min-width:auto;border-radius:5px;}.messages-container{flex-grow:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;}.message-bubble{max-width:70%;padding:10px 15px;border-radius:20px;margin-bottom:10px;line-height:1.4;word-wrap:break-word;}.message-bubble.sent{background-color:var(--secondary-accent);color:#fff;align-self:flex-end;border-bottom-right-radius:5px;}.message-bubble.received{background-color:#333;color:#fff;align-self:flex-start;border-bottom-left-radius:5px;}body.light-theme .message-bubble.received{background-color:#e4e6eb;color:#050505;}.chat-input-area{display:flex;padding:10px;border-top:1px solid var(--accent-color);}.chat-input-area input{flex-grow:1;margin:0 10px 0 0;}.chat-input-area button{width:auto;padding:0 25px;margin:0;}.incoming-call-text{animation:pulse 1.5s infinite;}@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}#call-view{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;}#remote-video{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;}#local-video{position:absolute;bottom:20px;right:20px;width:25%;max-width:180px;border:2px solid var(--accent-color);border-radius:10px;z-index:2001;cursor:move;}#local-video.hidden{display:none;}.call-controls{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);z-index:2002;}.call-info{position:absolute;top:30px;left:50%;transform:translateX(-50%);z-index:2002;background:rgba(0,0,0,.5);color:#fff;padding:10px 20px;border-radius:20px;text-align:center;}.call-info-emoji{font-size:40px;}.call-info-name,.call-info-status{font-size:20px;}
    </style>
</head>
<body>
    <video autoplay muted loop id="bg-video">
        <source src="mask.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div id="loader" class="container"><h1 class="app-title"><a href="https://t.me/MuskLinkBD" target="_blank">MaskLink</a></h1><p>Connecting...</p></div>
    <div id="auth-container" class="container hidden"><h1 class="app-title"><a href="https://t.me/MuskLinkBD" target="_blank">MaskLink</a></h1><div id="login-form" class="form-container"><p id="login-error" class="error-message hidden"></p><input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password"><button id="login-button">Login</button><p class="form-switch">Don't have an account? <span id="show-signup">Sign up</span></p></div><div id="signup-form" class="form-container hidden"><p id="signup-error" class="error-message hidden"></p><input type="email" id="signup-email" placeholder="Email"><input type="password" id="signup-password" placeholder="Password"><button id="signup-button">Sign Up</button><p class="form-switch">Already have an account? <span id="show-login">Log in</span></p></div></div>
    <div id="app-container" class="hidden">
        <!-- Modals -->
        <div id="profile-setup-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Setup Your Profile</h2><p id="profile-error" class="error-message hidden"></p><input type="text" id="profile-name" placeholder="Enter name"><input type="text" id="profile-emoji" placeholder="Enter emoji (e.g., üëΩ)" maxlength="2"><button id="save-profile-button">Save Profile</button></div></div>
        <div id="add-friend-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Add Friend</h2><p id="add-friend-error" class="error-message hidden"></p><p id="add-friend-success" class="hidden" style="color: var(--accent-color);">Request Sent!</p><input type="text" id="friend-mask-id-input" placeholder="mask-xxxx"><button id="send-friend-request-button">Send</button><button id="close-add-friend-modal-button" class="secondary">Close</button></div></div>
        <div id="menu-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Menu</h2><button id="menu-profile-button">View Profile</button><button id="menu-blocked-button">Blocked Users</button><button id="menu-theme-button">Theme</button><button id="menu-logout-button">Logout</button><button id="menu-close-button" class="secondary">Close</button></div></div>
        <div id="profile-view-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Your Profile</h2><p id="profile-update-error" class="error-message hidden"></p><input type="text" id="profile-edit-name"><input type="text" id="profile-edit-emoji" maxlength="2"><div class="profile-id-display">ID: <span id="profile-mask-id"></span></div><button id="profile-save-changes-button">Save</button><button id="profile-view-close-button" class="secondary">Close</button></div></div>
        <div id="incoming-call-modal" class="modal-overlay hidden"><div class="modal-content"><h2 class="incoming-call-text">Incoming Call</h2><div id="incoming-call-info" style="margin-bottom: 20px; font-size: 20px;"></div><button id="accept-call-button">Accept</button><button id="reject-call-button" class="danger">Reject</button></div></div>
        <div id="blocked-users-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Blocked Users</h2><div id="blocked-users-list"></div><button id="blocked-users-close-button" class="secondary">Close</button></div></div>
        <div id="friend-profile-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div id="friend-profile-emoji" style="font-size: 48px; margin-bottom: 10px;"></div>
                <h2 id="friend-profile-name" style="color: var(--text-color); margin-bottom: 20px;"></h2>
                <div class="profile-id-display">ID: <span id="friend-profile-mask-id"></span></div>
                <button id="friend-profile-close-button" class="secondary">Close</button>
            </div>
        </div>
        
        <!-- Main App Views -->
        <div id="main-app" class="main-app hidden"><div class="top-bar"><button class="nav-button" id="menu-button">Menu</button><div class="app-title-small"><a href="https://t.me/MuskLinkBD" target="_blank">MaskLink</a></div><button class="nav-button" id="add-friend-button">Add Friend</button></div><div class="main-content"><div id="pages-container"><div id="home-page" class="page active"><h2>Friends</h2><div id="contacts-list"></div></div><div id="notifications-page" class="page"><h2>Notifications</h2><div id="notifications-list"></div></div><div id="calls-page" class="page"><h2>Call Logs</h2><div id="call-log-list"></div></div></div></div><div class="bottom-bar"><button class="nav-button" data-page="home-page">Home</button><button class="nav-button" data-page="notifications-page">Notifications <span id="notification-badge" class="notification-badge hidden">0</span></button><button class="nav-button" data-page="calls-page">Calls</button></div></div>
        <div id="chat-view" class="hidden"><div class="chat-header"><button class="back-button" id="chat-back-button">‚Üê</button><div class="chat-header-info"><span id="chat-header-emoji"></span><span id="chat-header-name"></span></div><button class="block-button secondary" id="chat-block-button">Block</button></div><div class="messages-container" id="messages-container"></div><div class="chat-input-area"><input type="text" id="message-input" placeholder="Type a message..."><button id="send-message-button">Send</button></div></div>
        
        <div id="call-view" class="hidden"><video id="remote-video" autoplay playsinline></video><video id="local-video" autoplay playsinline muted></video><div class="call-info"><div class="call-info-emoji"></div><div class="call-info-name"></div><div class="call-info-status"></div></div><div class="call-controls"><button id="end-call-button" class="danger">End Call</button></div></div>
    </div>
    
    <audio id="ringtone" src="incoming.wav" loop></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: "AIzaSyD3VEv_rdd3FElJupOnfGrBQuLjGwACsA8",
          authDomain: "masklink-calling.firebaseapp.com",
          databaseURL: "https://masklink-calling-default-rtdb.firebaseio.com",
          projectId: "masklink-calling",
          storageBucket: "masklink-calling.appspot.com",
          messagingSenderId: "240213769733",
          appId: "1:240213769733:web:53e35fbf17e4b4d284266c"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUserData = null, activeListeners = [], peerConnection, localStream, incomingCallData;
        let userContacts = {}, blockedUsers = {}, unreadMessages = {}, onlineStatus = {}, currentOpenChatContactUid = null, currentCallContactUid = null;
        
        // --- CORRECTED: Added more STUN servers and a placeholder for a TURN server ---
        // You MUST get real TURN server credentials from a service like Twilio, Metered, Xirsys etc. for reliable calling across different networks.
        const stunServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                // {
                //   urls: 'turn:your-turn-server.com:3478', // Replace with your TURN server URL
                //   username: 'your-username',             // Replace with your username
                //   credential: 'your-password'            // Replace with your password
                // }
            ]
        };

        const ui = {loader: document.getElementById('loader'),auth: document.getElementById('auth-container'),app: document.getElementById('app-container'),main: document.getElementById('main-app'),chat: document.getElementById('chat-view'),profileSetup: document.getElementById('profile-setup-modal'),call: document.getElementById('call-view'),incomingCall: document.getElementById('incoming-call-modal'),ringtone: document.getElementById('ringtone')};

        auth.onAuthStateChanged(user => user ? loadUserDataAndStartApp(user) : cleanupAndShowUI('auth'));
        function loadUserDataAndStartApp(user) {database.ref('users/' + user.uid).once('value', s => {if (s.exists()) {currentUserData = s.val();cleanupAndShowUI('app');startAppListeners(user.uid);} else {cleanupAndShowUI('profileSetup');}});}
        function cleanupAndShowUI(uiName) {
            activeListeners.forEach(({ ref, eventType, callback }) => ref.off(eventType, callback)); activeListeners = [];
            if (uiName === 'auth') { currentUserData = null; userContacts = {}; blockedUsers = {}; unreadMessages = {}; onlineStatus = {}; currentOpenChatContactUid = null; }
            Object.values(ui).forEach(v => v.classList.add('hidden'));
            const viewToShow = (uiName === 'profileSetup' || uiName === 'app') ? ui.app : ui[uiName];
            if(uiName !== 'app') document.body.style.background = 'var(--bg)'; 
            if (viewToShow) viewToShow.classList.remove('hidden');
            if (uiName === 'profileSetup') ui.profileSetup.classList.remove('hidden');
            if (uiName === 'app') ui.main.classList.remove('hidden');
        }

        function attachAllEventListeners() {
            document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
            document.getElementById('login-button').addEventListener('click', handleAuth(false));
            document.getElementById('signup-button').addEventListener('click', handleAuth(true));
            document.getElementById('save-profile-button').addEventListener('click', handleProfileSave);
            document.getElementById('menu-button').addEventListener('click', () => document.getElementById('menu-modal').classList.remove('hidden'));
            document.getElementById('add-friend-button').addEventListener('click', () => document.getElementById('add-friend-modal').classList.remove('hidden'));
            document.getElementById('chat-back-button').addEventListener('click', () => { ui.chat.classList.add('hidden'); ui.main.classList.remove('hidden'); currentOpenChatContactUid = null; });
            document.querySelectorAll('.bottom-bar .nav-button').forEach(btn => btn.addEventListener('click', e => {document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));document.getElementById(e.currentTarget.dataset.page).classList.add('active');}));
            document.getElementById('menu-close-button').addEventListener('click', () => document.getElementById('menu-modal').classList.add('hidden'));
            document.getElementById('menu-logout-button').addEventListener('click', () => { if(currentUserData) { database.ref('/status/' + currentUserData.uid).set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP }); } auth.signOut(); });
            document.getElementById('menu-profile-button').addEventListener('click', openProfileViewModal);
            document.getElementById('menu-theme-button').addEventListener('click', toggleTheme);
            document.getElementById('menu-blocked-button').addEventListener('click', openBlockedUsersModal);
            document.getElementById('close-add-friend-modal-button').addEventListener('click', () => document.getElementById('add-friend-modal').classList.add('hidden'));
            document.getElementById('send-friend-request-button').addEventListener('click', sendFriendRequest);
            document.getElementById('profile-view-close-button').addEventListener('click', () => document.getElementById('profile-view-modal').classList.add('hidden'));
            document.getElementById('profile-save-changes-button').addEventListener('click', saveProfileChanges);
            document.getElementById('blocked-users-close-button').addEventListener('click', () => document.getElementById('blocked-users-modal').classList.add('hidden'));
            document.getElementById('friend-profile-close-button').addEventListener('click', () => document.getElementById('friend-profile-modal').classList.add('hidden'));
            document.getElementById('accept-call-button').addEventListener('click', handleAcceptCall);
            document.getElementById('reject-call-button').addEventListener('click', handleRejectCall);
            document.getElementById('end-call-button').addEventListener('click', () => endCall(true));
            applyTheme(localStorage.getItem('masklink-theme') || 'dark');
            requestNotificationPermission(); 
        }
        
        const handleAuth=(i)=>()=>{const e=i?"signup":"login",t=document.getElementById(`${e}-email`).value.trim(),d=document.getElementById(`${e}-password`).value.trim(),l=document.getElementById(`${e}-error`);l.classList.add("hidden"),t&&d?(i?auth.createUserWithEmailAndPassword(t,d):auth.signInWithEmailAndPassword(t,d)).catch(e=>{l.textContent=e.message,l.classList.remove("hidden")}):(l.textContent="Email & Password required.",l.classList.remove("hidden"))};
        function handleProfileSave() {const e=auth.currentUser;if(!e)return;const t=document.getElementById("profile-name").value.trim(),d=document.getElementById("profile-emoji").value.trim(),l=document.getElementById("profile-error");if(l.classList.add("hidden"),!t||!d)return l.textContent="Name & emoji required.",void l.classList.remove("hidden");const n=`mask-${Math.random().toString(36).substr(2,4)}`,a={name:t,emoji:d,uid:e.uid,maskId:n,email:e.email},o={};o[`/users/${e.uid}`]=a,o[`/maskIds/${n}`]=e.uid,database.ref().update(o).then(()=>loadUserDataAndStartApp(e)).catch(e=>{l.textContent=e.message,l.classList.remove("hidden")})}
        
        function startAppListeners(uid) {
            const addListener=(r,e,t)=>{r.on(e,t);activeListeners.push({ref:r,eventType:e,callback:t})};
            
            const unreadMarkersRef = database.ref(`unread_markers/${uid}`);
            
            unreadMarkersRef.once('value', snapshot => { unreadMessages = snapshot.val() || {}; renderFriendList(); });

            addListener(unreadMarkersRef, 'child_added', handleNewUnreadMessage);
            addListener(unreadMarkersRef, 'child_removed', handleReadMessage);
            
            addListener(database.ref(`users/${uid}`),'value',s=>{currentUserData=s.val()});
            addListener(database.ref(`contacts/${uid}`),'value', handleContactsUpdate);
            addListener(database.ref(`requests/${uid}`),'value',renderFriendRequests);
            addListener(database.ref(`callLogs/${uid}`),'value',renderCallLogs);
            addListener(database.ref(`calls/${uid}`),'value',handleIncomingCallSignal);
            addListener(database.ref(`blocked/${uid}`), 'value', handleBlockedUsersUpdate);
            addListener(database.ref('/status'), 'value', handleOnlineStatusUpdate);
            setupPresenceSystem(uid);
        }

        async function handleNewUnreadMessage(snapshot) {
            const senderUid = snapshot.key;
            unreadMessages[senderUid] = true;
            renderFriendList();

            if ((currentOpenChatContactUid === senderUid && !document.hidden)) return;

            const contactInfo = userContacts[senderUid];
            if (contactInfo) {
                const chatID = generateChatID(currentUserData.uid, senderUid);
                const lastMessageSnapshot = await database.ref(`messages/${chatID}`).orderByChild('timestamp').limitToLast(1).once('value');
                if(lastMessageSnapshot.exists()) {
                    const messageData = Object.values(lastMessageSnapshot.val())[0];
                    showNotification(`${contactInfo.emoji} ${contactInfo.name}`, messageData.text);
                }
            }
        }

        function handleReadMessage(snapshot) {
            const senderUid = snapshot.key;
            delete unreadMessages[senderUid];
            renderFriendList();
        }
        
        function handleContactsUpdate(snapshot) { userContacts = snapshot.val() || {}; renderFriendList(); }
        function handleBlockedUsersUpdate(snapshot) { blockedUsers = snapshot.val() || {}; renderFriendList(); }
        function handleOnlineStatusUpdate(snapshot) { onlineStatus = snapshot.val() || {}; renderFriendList(); }
        
        function renderFriendList() {
            if (!currentUserData) return;
            const list = document.getElementById('contacts-list'); list.innerHTML = '';
            if (Object.keys(userContacts).length === 0) { list.innerHTML = '<p>Your friends list is empty.</p>'; return; }

            Object.values(userContacts).forEach(c => {
                if (blockedUsers[c.uid]) return;
                
                const status = onlineStatus[c.uid]?.state === 'online' ? 'online' : 'offline';
                const statusIndicator = `<span class="status-indicator ${status}"></span>`;
                const unreadIndicator = unreadMessages[c.uid] ? '<span class="unread-dot"></span>' : '';

                const el = document.createElement('div'); el.className = 'list-item';
                const mainInfo = document.createElement('div'); mainInfo.className = 'list-item-main-info';
                mainInfo.innerHTML = `<span class="list-item-emoji">${statusIndicator}${c.emoji}</span><div class="list-item-info"><span class="list-item-name">${c.name}</span>${unreadIndicator}</div>`;
                mainInfo.onclick = () => showChatView(c);
                const actions = document.createElement('div'); actions.className = 'list-item-actions';
                actions.innerHTML = `<button data-uid="${c.uid}" class="secondary">Profile</button><button data-uid="${c.uid}" data-type="video">Video</button><button data-uid="${c.uid}" data-type="audio">Voice</button>`;
                actions.querySelector('[class="secondary"]').onclick = () => showFriendProfile(c.uid);
                actions.querySelector('[data-type="video"]').onclick = () => initiateCall(c.uid, 'video');
                actions.querySelector('[data-type="audio"]').onclick = () => initiateCall(c.uid, 'audio');
                el.appendChild(mainInfo); el.appendChild(actions); list.appendChild(el);
            });
        }
        function renderFriendRequests(snapshot) {const list = document.getElementById('notifications-list'); const badge = document.getElementById('notification-badge'); list.innerHTML = '';if (!snapshot.exists()) { list.innerHTML = '<p>No notifications.</p>'; badge.classList.add('hidden'); return; }const reqs = snapshot.val(); const count = Object.keys(reqs).length;badge.textContent = count; badge.classList.remove('hidden');Object.entries(reqs).forEach(([k, v]) => list.appendChild(createRequestElement(k,v)));}
        function createRequestElement(key, request) {const el=document.createElement("div");el.className="list-item";el.innerHTML=`<span class="list-item-emoji">${request.senderEmoji}</span><div class="list-item-info"><span class="list-item-name">${request.senderName}</span><span>wants to connect.</span></div><div class="list-item-actions"><button>Accept</button><button class="danger">Reject</button></div>`;el.querySelector("button:first-child").onclick=()=>handleRequest(key,request.senderUid,!0);el.querySelector("button:last-child").onclick=()=>handleRequest(key,request.senderUid,!1);return el}
        function renderCallLogs(snapshot) {const list=document.getElementById('call-log-list');list.innerHTML='';if(!snapshot.exists()){list.innerHTML='<p>Call history is empty.</p>';return}const logs=[];snapshot.forEach(s=>logs.push(s.val()));logs.reverse().forEach(log=>{const el=document.createElement('div');el.className='list-item';el.innerHTML=`<span class="list-item-emoji">${log.type==='video'?'üìπ':'üìû'}</span><div class="list-item-info"><span class="list-item-name">${log.contactName} (${log.direction})</span><span>${new Date(log.timestamp).toLocaleString()}</span></div>`;list.appendChild(el)})}
        
        async function handleRequest(key, senderUid, accepted) {const myUid = auth.currentUser.uid;if (!myUid) return;const reqRef = database.ref(`requests/${myUid}/${key}`);if (!accepted) { await reqRef.remove(); return; }const senderSnap = await database.ref(`users/${senderUid}`).once('value');const senderData = senderSnap.val();if (!senderData || !currentUserData) return;const updates = {};updates[`/contacts/${myUid}/${senderUid}`] = {name: senderData.name, emoji: senderData.emoji, uid: senderData.uid};updates[`/contacts/${senderUid}/${myUid}`] = {name: currentUserData.name, emoji: currentUserData.emoji, uid: currentUserData.uid};updates[`/requests/${myUid}/${key}`] = null;await database.ref().update(updates);}
        function showChatView(contact) {
            if (blockedUsers[contact.uid]) { alert("This user is blocked."); return; }
            currentOpenChatContactUid = contact.uid;
            database.ref(`unread_markers/${currentUserData.uid}/${contact.uid}`).remove();
            ui.main.classList.add('hidden');ui.chat.classList.remove('hidden');
            document.getElementById('chat-header-name').textContent=contact.name; document.getElementById('chat-header-emoji').textContent=contact.emoji;
            const blockBtn = document.getElementById('chat-block-button'); blockBtn.onclick = () => blockUser(contact);
            const oldListener=activeListeners.find(l=>l.ref.toString().includes('/messages/'));
            if(oldListener){oldListener.ref.off(oldListener.eventType,oldListener.callback);activeListeners=activeListeners.filter(l=>l!==oldListener)}
            const chatID=generateChatID(currentUserData.uid,contact.uid);
            document.getElementById('messages-container').innerHTML='';
            const msgInput=document.getElementById('message-input'),sendBtn=document.getElementById('send-message-button');
            sendBtn.onclick=()=>sendMessage(chatID,msgInput,contact.uid);
            msgInput.onkeyup=e=>{if(e.key==='Enter')sendMessage(chatID,msgInput,contact.uid)};
            const chatRef=database.ref(`messages/${chatID}`).orderByChild('timestamp').limitToLast(50);
            const messageCallback=snapshot=>displayMessage(snapshot.val());
            chatRef.on('child_added',messageCallback);activeListeners.push({ref:chatRef,eventType:'child_added',callback:messageCallback})
        }
        function sendMessage(chatID, inputEl, recipientUid) {
            const text = inputEl.value.trim(); if (text === "") return;
            const msgData = { text: text, senderId: currentUserData.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
            database.ref(`messages/${chatID}`).push(msgData);
            database.ref(`unread_markers/${recipientUid}/${currentUserData.uid}`).set(true);
            inputEl.value = "";
        }
        function toggleTheme(){let e=document.body.classList.contains("light-theme")?"dark":"light";localStorage.setItem("masklink-theme",e);applyTheme(e)}function applyTheme(e){document.body.classList.toggle("light-theme",e==="light")}
        function openProfileViewModal(){if(!currentUserData)return;document.getElementById('profile-edit-name').value=currentUserData.name;document.getElementById('profile-edit-emoji').value=currentUserData.emoji;document.getElementById('profile-mask-id').textContent=currentUserData.maskId;document.getElementById('profile-view-modal').classList.remove('hidden');document.getElementById('menu-modal').classList.add('hidden')}
        async function saveProfileChanges(){const e=document.getElementById("profile-edit-name").value.trim(),t=document.getElementById("profile-edit-emoji").value.trim(),a=document.getElementById("profile-update-error");if(!e||!t)return a.textContent="Name and Emoji cannot be empty.",void a.classList.remove("hidden");database.ref("users/"+currentUserData.uid).update({name:e,emoji:t}).then(()=>document.getElementById('profile-view-modal').classList.add("hidden")).catch(e=>{a.textContent=e.message,a.classList.remove("hidden")})}
        function showFriendProfile(friendUid) {database.ref(`users/${friendUid}`).once('value', snapshot => {if (snapshot.exists()) {const friendData = snapshot.val();document.getElementById('friend-profile-emoji').textContent = friendData.emoji;document.getElementById('friend-profile-name').textContent = friendData.name;document.getElementById('friend-profile-mask-id').textContent = friendData.maskId;document.getElementById('friend-profile-modal').classList.remove('hidden');} else {alert("Could not load friend's details.");}});}
        
        function requestNotificationPermission() { if (!('Notification' in window)) return; if (Notification.permission !== 'denied') Notification.requestPermission(); }
        function showNotification(title, body) { if ('Notification' in window && Notification.permission === 'granted') { new Notification(title, { body: body, tag: 'masklink-message' }); } }

        function setupPresenceSystem(uid) {
            const userStatusDatabaseRef = database.ref('/status/' + uid);
            const isOfflineForDatabase = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };
            const isOnlineForDatabase = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) { return; }
                userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(() => { userStatusDatabaseRef.set(isOnlineForDatabase); });
            });
        }
        function blockUser(contactToBlock) {if (confirm(`Are you sure you want to block ${contactToBlock.name}?`)) {database.ref(`blocked/${currentUserData.uid}/${contactToBlock.uid}`).set(true).then(() => { alert(`${contactToBlock.name} has been blocked.`); ui.chat.classList.add('hidden'); ui.main.classList.remove('hidden'); });}}
        function unblockUser(uidToUnblock) {database.ref(`blocked/${currentUserData.uid}/${uidToUnblock}`).remove().then(() => {alert("User unblocked."); document.getElementById('blocked-users-modal').classList.add('hidden');});}
        function openBlockedUsersModal() {const listEl = document.getElementById('blocked-users-list'); listEl.innerHTML = '';if (Object.keys(blockedUsers).length === 0) { listEl.innerHTML = '<p>No blocked users.</p>'; } else {Object.keys(blockedUsers).forEach(uid => {database.ref(`users/${uid}`).once('value', snapshot => {const userData = snapshot.val();const item = document.createElement('div'); item.className = 'list-item';item.innerHTML = `<div class="list-item-main-info"><span class="list-item-emoji">${userData.emoji}</span><div class="list-item-info"><span class="list-item-name">${userData.name}</span></div></div><button class="danger">Unblock</button>`;item.querySelector('button').onclick = () => unblockUser(uid);listEl.appendChild(item);});});}document.getElementById('blocked-users-modal').classList.remove('hidden');document.getElementById('menu-modal').classList.add('hidden');}
        
        // --- CALLING LOGIC ---
        async function initiateCall(calleeUid, type) {
            console.log(`Initiating ${type} call to ${calleeUid}`);
            if (blockedUsers[calleeUid]) { alert("Cannot call a blocked user."); return; }
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('local-video').srcObject = localStream;
                setupPeerConnection(calleeUid);
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                console.log("Offer created and set as local description.");
                const callData = { offer, from: currentUserData.uid, name: currentUserData.name, emoji: currentUserData.emoji, type };
                await database.ref(`calls/${calleeUid}`).set(callData);
                console.log("Call data sent to Firebase.");
                currentCallContactUid = calleeUid;
                const contactData = await database.ref(`users/${calleeUid}`).once('value');
                showCallUI(type, contactData.val(), 'Calling...');
            } catch (err) { console.error("Call Initiation Error:", err); alert("Could not start call. Check camera/mic permissions and console for errors."); }
        }
        
        function handleIncomingCallSignal(snapshot) {
            const callData = snapshot.val();
            console.log("Received call signal from Firebase:", callData);
            if (!callData) return;

            if (callData.offer && !peerConnection) {
                if (blockedUsers[callData.from]) { database.ref(`calls/${currentUserData.uid}`).remove(); return; }
                console.log("Incoming call offer from:", callData.from);
                incomingCallData = callData;
                currentCallContactUid = callData.from;
                document.getElementById('incoming-call-info').textContent = `${callData.emoji} ${callData.name} is calling...`;
                ui.incomingCall.classList.remove('hidden');
                ui.ringtone.play();
            } else if (callData.answer && peerConnection?.signalingState === 'have-local-offer') {
                console.log("Received answer.");
                peerConnection.setRemoteDescription(new RTCSessionDescription(callData.answer));
            } else if (callData.iceCandidate && peerConnection) {
                console.log("Received new ICE candidate.");
                peerConnection.addIceCandidate(new RTCIceCandidate(callData.iceCandidate));
            } else if (callData.rejection || callData.hangup) {
                alert("Call " + (callData.rejection ? "Rejected" : "Ended"));
                endCall(false);
            }
        }
        
        async function handleAcceptCall() {
            console.log("Accepting call from:", incomingCallData.from);
            try {
                ui.ringtone.pause();
                ui.incomingCall.classList.add('hidden');
                localStream = await navigator.mediaDevices.getUserMedia({ video: incomingCallData.type === 'video', audio: true });
                document.getElementById('local-video').srcObject = localStream;
                setupPeerConnection(incomingCallData.from);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log("Answer created and set as local description.");
                await database.ref(`calls/${incomingCallData.from}`).update({ answer });
                console.log("Answer sent to Firebase.");
                showCallUI(incomingCallData.type, incomingCallData, 'Connecting...');
                incomingCallData = null;
            } catch (err) { console.error("Accept Call Error:", err); alert("Could not accept call. Check permissions and console.");}
        }

        function handleRejectCall() {
            console.log("Rejecting call.");
            ui.ringtone.pause();
            ui.incomingCall.classList.add('hidden');
            if(incomingCallData?.from) { database.ref(`calls/${incomingCallData.from}`).update({ rejection: true }); }
            database.ref(`calls/${currentUserData.uid}`).remove();
            incomingCallData = null;
        }

        function setupPeerConnection(contactUid) {
            console.log("Setting up PeerConnection...");
            peerConnection = new RTCPeerConnection(stunServers);
            
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    console.log("Sending ICE candidate to remote peer.");
                    database.ref(`calls/${contactUid}`).update({ iceCandidate: e.candidate.toJSON() });
                }
            };
            
            peerConnection.ontrack = e => {
                console.log("Received remote track.");
                document.getElementById('remote-video').srcObject = e.streams[0];
            };
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                console.log("Peer connection state changed to:", state);
                if (state === 'disconnected' || state === 'closed' || state === 'failed') {
                    console.error("Call disconnected or failed.");
                    endCall(false);
                } else if (state === 'connected') {
                    console.log("Call connected successfully!");
                    document.querySelector('.call-info-status').textContent = 'Connected';
                    database.ref(`calls/${currentUserData.uid}`).remove(); // Clean up my own call signal
                }
            };
        }
        
        function showCallUI(type, contactInfo, status) {
            ui.call.classList.remove('hidden');
            ui.main.classList.add('hidden');
            ui.chat.classList.add('hidden');
            document.querySelector('.call-info-emoji').textContent = contactInfo.emoji;
            document.querySelector('.call-info-name').textContent = contactInfo.name;
            document.querySelector('.call-info-status').textContent = status;
            const isAudioOnly = type === 'audio';
            document.getElementById('remote-video').style.visibility = isAudioOnly ? 'hidden' : 'visible';
            document.getElementById('local-video').style.visibility = isAudioOnly ? 'hidden' : 'visible';
        }

        function endCall(sendHangup = true) {
            console.log("Ending call. Send hangup signal:", sendHangup);
            if (sendHangup && currentCallContactUid) {
                database.ref(`calls/${currentCallContactUid}`).update({ hangup: true });
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            ui.ringtone.pause();
            ui.call.classList.add('hidden');
            ui.incomingCall.classList.add('hidden');
            ui.main.classList.remove('hidden');
            database.ref(`calls/${currentUserData.uid}`).remove();
            incomingCallData = null;
            currentCallContactUid = null;
        }

        // --- Other Functions ---
        async function sendFriendRequest(){const i=document.getElementById("friend-mask-id-input"),id=i.value.trim(),e=document.getElementById("add-friend-error"),s=document.getElementById("add-friend-success");e.classList.add("hidden");s.classList.add("hidden");if(!id){e.textContent="Mask ID required";e.classList.remove("hidden");return}if(id===currentUserData.maskId){e.textContent="You can't add yourself.";e.classList.remove("hidden");return}try{const r=await database.ref("maskIds").child(id).once("value");if(!r.exists()){e.textContent="User not found.";e.classList.remove("hidden");return}const u=r.val(),c=await database.ref(`contacts/${currentUserData.uid}/${u}`).once("value");if(c.exists()){e.textContent="Already friends.";e.classList.remove("hidden");return}const d={senderUid:currentUserData.uid,senderName:currentUserData.name,senderEmoji:currentUserData.emoji};await database.ref(`requests/${u}`).push(d);s.classList.remove("hidden");i.value="";setTimeout(()=>document.getElementById("add-friend-modal").classList.add("hidden"),2e3)}catch(t){e.textContent=t.message;e.classList.remove("hidden")}}
        function generateChatID(a,b){return a<b?`${a}_${b}`:`${b}_${a}`}
        function displayMessage(msg){const el=document.createElement("div");el.className="message-bubble";el.textContent=msg.text;el.classList.add(msg.senderId===currentUserData.uid?"sent":"received");const cont=document.getElementById("messages-container");cont.appendChild(el);cont.scrollTop=cont.scrollHeight}
        
        attachAllEventListeners();
    });
    </script>
</body>
</html>